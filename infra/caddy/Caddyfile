{
    admin off
    auto_https disable_redirects
}

:80 {
    log {
        output file /var/log/caddy/access.log
        format json
    }

    # CORS headers
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "*"
    header Access-Control-Allow-Headers "*"

    # Handle CORS preflight
    @options method OPTIONS
    respond @options 204

    # Proxy all API requests (auth handled by backend)
    handle /api/* {
        reverse_proxy api:8000
    }

    handle /metrics {
        basicauth {
            admin $2a$14$hashed_password
        }
        reverse_proxy api:8000
    }

    handle /grafana/* {
        uri strip_prefix /grafana
        reverse_proxy grafana:3000
    }

    handle /flower/* {
        @internal_only {
            remote_ip 172.28.0.0/16 10.0.0.0/8 192.168.0.0/16
        }

        handle @internal_only {
            uri strip_prefix /flower
            reverse_proxy flower:5555
        }

        handle {
            respond "Forbidden" 403
        }
    }

    handle /health {
        reverse_proxy api:8000
    }

    handle {
        respond "Not Found" 404
    }
}
